## 4장. 커넥션 관리

[1. HTTP 가 TCP 커넥션을 사용하는 방법](#HTTP-가-TCP-커넥션을-사용하는-방법)

[2. TCP 커넥션의 지연, 병목](#TCP-커넥션의-지연,-병목)

## HTTP 가 TCP 커넥션을 사용하는 방법
* HTTP 통신은 TCP/IP를 통해 이루어진다. TCP는 커넥션이 맺어지면 안전한 전송을 보장(TCP의 특징 - 신뢰성)하기 때문에 HTTP 메시지 또한 안전하게 전달된다.

#### 신뢰성있는 TCP
* TCP 스트림은 세그먼트로 나뉘어 IP 패킷을 통해 전송된다. TCP 는 세그먼트라는 단위로 데이터 스트림을 잘게 나누고, 세그먼트를 IP 패킷에 담아 인터넷을 통해 전달한다.
* 각 TCP 세그먼트는 하나의 IP 주소에서 다른 IP 주소로 IP 패킷에 담겨 전달된다. IP 패킷은 크게 세 가지로 구성된다.
	1. IP 패킷 헤더
	2. TCP 세그먼트 헤더
	3. TCP 데이터 조각

#### TCP 커넥션
* TCP는 <발신지 IP 주소, 발신지 포트 번호 / 수신지 IP 주소, 수신지 포트 번호> 네 가지 값으로 유일한 커넥션을 생성한다.
* TCP는 여러 개의 커넥션을 동시에 유지할 수 있다.

## TCP 커넥션의 지연, 병목
* HTTP는 TCP 계층 위에서 동작하는 계층의 프로토콜이기 때문에 HTTP 트랜잭션의 성능은 TCP의 성능에 영향을 받는다. 그래서 TCP의 특성을 알아야 커넥션 최적화 요소를 알 수 있다.

#### HTTP 트랜잭션을 지연시키는 원인
1. DNS 를 통해 host name 을 IP 주소로 변환하는데, 최근에 방문한 적이 경는 경우
	* 하지만 현대 인프라의 발전으로 이 시간은 1000ms 미만으로 끝난다.
	* 대부분의 HTTP 클라이언트는 최근 접속한 사이트의 IP 주소를 DNS 캐시에 가지고 있다. 이전에 방문한 곳이라면 로컬에 캐시되어 있기 때문에 더욱 빠르게 찾을 수 있다.
2. TCP 커넥션 연결
	* HTTP 통신을 위해서 TCP 커넥션 연결이 이루어지는데, 그 과정에서 약간의 지연을 발생시킨다. 매번 HTTP 통신마다 커넥션을 맺지 않고 최초 한 번만 커넥션을 맺는다면 비용을 줄일 수 있다.
	* HTTP 1.1 에 나온 Keep-Alive 을 사용하면 커넥션을 유지하여 비용을 줄일 수 있다.
3. 서버의 처리 로직, 응답을 보내는 과정이 느린 경우

#### TCP 성능 지연 원인
1. TCP 커넥션 handshake
2. TCP 의 느린 시작(slow start)
3. [네이글(Nagle) 알고리즘](#네이글(Nagle)-알고리즘)
4. TCP 편승을 위한 확인응답 알고리즘
	* 데이터를 ACK 에 편승시켜 같이 보내는 것
5. TIME_WAIT 지연과 포트 고갈

→ 지연 원인 중 'handshake' 와 '느린 시작'은 keep-alive 를 통해 해결할 수 있다.

#### 네이글(Nagle) 알고리즘
* 네이글 알고리즘이란?
	* 데이터를 작게 여러번 전송하지 말고 한 번에 전송하는 것
* 전송 방법
	* 일반적인 통신 방법
		* 패킷을 나누어 전송할 때 패킷을 하나씩 전송하는데, 하나의 패킷 전송에 대한 ACK 패킷을 클라이언트로부터 받기 전까지 대기하고 ACK 를 받으면 다음 패킷을 전송하는 방법
	* 네이글 알고리즘 통신 방법
		* 클라이언트로부터 ACK 를 받기 전에 미리 송신 버퍼에 전송할 패킷을 저장해두고 있다가 ACK 패킷을 받으면 여러 개의 패킷을 한 번에 모아서 전송하는 방법
* 장단점
	* 장점 : 한 번에 많은 패킷을 전송하기 때문에 전송 횟수가 둘어들면서 네트워크 효율성이 높아진다.
	* 단점 : ACK 를 받을때 까지 패킷을 송신 버퍼에 모아두기 때문에 오히려 속도가 느려질 수도 있다.

